# WikiBench

**Русский бенчмарк для оценки аналитических способностей больших языковых моделей посредством генерации статей в стиле Википедии**

---

## Содержание

1. [Описание](#описание)
2. [Кратко об этапах оценки](#кратко-об-этапах-оценки)
3. [Структура репозитория](#структура-репозитория)
4. [Установка](#установка)
5. [Пример использования](#пример-использования)
6. [Параметры](#параметры)

---

## Описание

WikiBench — это бенчмарк, предоставляющий **трехэтапный** метод оценки, который проверяет, насколько хорошо языковая модель умеет:

1. **Находить и ранжировать релевантные источники** для статьи "Рувики";
2. **Формировать связный план статьи** на базе предоставленных источников;
3. **Писать качественный текст секций**, опираясь исключительно на информацию из соответствующих источников.

Бенчмарк полностью автоматизирован и включает:

* Подборку статей российской интернет-энциклопедии "Рувики";
* Эталонные тексты источников и ссылки на них;
* Метрики для каждого этапа;
* Удобный Python‑интерфейс (`WikiBench`).

---

## Кратко об этапах оценки

### Этап 1: Ранжирование

BM25 выдает смесь релевантных и нерелевантынх сниппетов; модель помечает каждый как «да/нет». Оценка строится по лог‑вероятностям ответов, стимулируя как правильность, так и уверенность в ответе.

### Этап 2: План

Сниппеты преобразуются в эмбеддинги и кластеризуются. Модель получает либо тексты кластеров, либо их краткие описания и формирует иерархический план статьи.

### Этап 3: Секции

Для каждой секции берутся свои сниппеты, группируются по косинусному сходству (>0.8), после чего модель итеративно разворачивает краткие описания групп в полноценный текст секции.

---

## Структура репозитория

```text
.
├── Articles/                     # Данные для оценки
│   ├── Sources/                  # Тексты источников, сгруппированные по статьям
│   └── Links/                    # Сохраненные URL‑адреса источников
│   └── Html/                     # Сохраненные HTML-коды статей
├── Generation/                   # Закешированные обработанные данные
│   ├── Utils/                    #
|   │   ├── bm25_index/           # Проиндексированный в BM25 корпус
|   │   ├── embeddings/           # Эмбеддинги текстов сниппетов
|   │   ├── text_corpus/          # Набор сниппетов
├── src/                          # Исходный код бенчмарка
│   ├── openai_utils.py           # LLMCompleter для обращения к LLM + AsyncList
│   ├── wiki_parse.py             # WikiParse — парсер HTML Википедии
│   ├── wiki_extract.py           # WikiExtracter — скачивание источников
│   ├── wiki_gen.py               # WikiGen — все промпты для генерации и обработка запросов
│   ├── wiki_utils.py             # WikiUtils — сниппеты, эмбеддинги, BM25 и др.
│   ├── wiki_metrics.py           # WikiEval — метрики для трех этапов
│   └── wiki_bench.py             # WikiBench — основной модуль, объединяющий все вышеперечисленные
├── main.ipynb                    # Демонстрация работы бенчмарка
└── requirements.txt              # Необходимые модули и библиотеки
```

---

## Установка

```bash
# 1. Клонируем репозиторий
$ git clone https://github.com/Nejimaki-Tori/WikiBench.git
$ cd WikiBench

# 2. Устанавливаем зависимости
$ pip install -r requirements.txt
```

---

## Пример использования

```python
import sys
sys.path.append("src")
from wiki_bench import WikiBench

bench = WikiBench(
    api_key="KEY",
    api_base="URL",
    model_name="qwen2.5-72b"
)

# Шаг 0: подготовка окружения (скачивание данных, эмбеддингов и т. д.)
# bench.prepare_env()

# --- Независимые оценки генерации-----------------------------------------
# 1. Ранжирование источников
score_query = bench.rank_query(reference_mode=0)
print("Score (query):", score_query)

# 2. Генерация плана
score_outline = bench.rank_outline(
    neighbour_count=1,      # число соседних сниппетов
    description_mode=0,     # 0 — напрямую по кластеру, 1 — через описание
    mode=1                  # 0 — чистый k‑means, 1 — фиксированные центры
)
print("Score (outline):", score_outline)

# 3. Генерация секций
score_sections = bench.rank_sections()
print("Score (sections):", score_sections)
```

Каждый метод возвращает кортеж с числовыми значениями метрик. Можно вызывать их отдельно или все сразу.

---

## Параметры

| Метод           | Параметр           | Значение по умолчанию | Что делает                                                                             |
| --------------- | ------------------ | ------------ | -------------------------------------------------------------------------------------- |
| `rank_query`    | `reference_mode`   | `1`          | 0 — описание статьи генерирует **оцениваемая** модель; 1 — берется готовое «эталонное» описание |
| `rank_outline`  | `neighbour_count`  | `0`          | Сколько соседних сниппетов добавить к каждому сниппету‑центру                          |
|       `rank_outline`          | `description_mode` | `0`          | 0 — сразу генерируется план; 1 — сначала описание кластера, затем план                   |
|          `rank_outline`       | `mode`             | `1`          | 0 — k‑means без подсказок; 1 — фиксированные центры кластеров: эмбеддинги соответствующих сниппетов       |
| `rank_sections` | —                  | —            | Доп. параметров нет                        |


---
